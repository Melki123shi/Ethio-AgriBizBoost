name: "Build & Release"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      - dev
      - "impl/*"
      - "feature/*"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  lint_shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ludeeus/action-shellcheck@master

  # Backend setup and tests
  backend_tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.10"]
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            backend/.venv
          key: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-python-${{ matrix.python-version }}-

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run backend tests
        working-directory: backend
        run: |
          # Run tests if they exist
          if [ -d "tests" ] || [ -n "$(find . -name 'test_*.py' -o -name '*_test.py')" ]; then
            python -m pytest --cov=. --cov-report=xml --cov-report=html
          else
            echo "No backend tests found, skipping..."
          fi

  # Frontend unit tests (matching unit_test_runner.ps1)
  frontend_unit_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            frontend/.dart_tool
            frontend/build
          key: ${{ runner.os }}-flutter-unit-${{ hashFiles('frontend/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-unit-

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"

      - name: Install dependencies
        working-directory: frontend
        run: |
          flutter pub get
          flutter pub global activate coverage

      - name: Regenerate mocks
        working-directory: frontend
        run: |
          flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        working-directory: frontend
        run: flutter analyze --no-fatal-infos

      - name: Run Critical Foundation Tests (Phase 1)
        working-directory: frontend
        run: |
          echo "Running Critical Foundation Tests..."
          flutter test test/core/services/token_storage_test.dart || true
          flutter test test/features/auth/domain/entity/login_entity_test.dart || true
          flutter test test/features/auth/domain/entity/signup_entity_test.dart || true

      - name: Run Infrastructure Tests (Phase 2)
        working-directory: frontend
        run: |
          echo "Running Infrastructure Tests..."
          flutter test test/core/network/dio_client_test.dart || true

      - name: Run Core Service Tests
        working-directory: frontend
        run: |
          echo "Running Core Service Tests..."
          if [ -d "test/core/services/" ]; then
            flutter test test/core/services/ --coverage
          fi
          if [ -d "test/core/network/" ]; then
            flutter test test/core/network/ --coverage
          fi

      - name: Run Authentication Unit Tests
        working-directory: frontend
        run: |
          echo "Running Authentication Unit Tests..."
          # Entity Tests
          if [ -d "test/features/auth/domain/entity/" ]; then
            flutter test test/features/auth/domain/entity/ --coverage
          fi
          # DTO Tests
          if [ -d "test/features/auth/domain/dto/" ]; then
            flutter test test/features/auth/domain/dto/ --coverage
          fi
          # Service Tests
          if [ -d "test/features/auth/data/services/" ]; then
            flutter test test/features/auth/data/services/ --coverage
          fi
          # BLoC Tests
          if [ -d "test/features/auth/presentation/bloc/" ]; then
            flutter test test/features/auth/presentation/bloc/ --coverage
          fi

      - name: Run Feature Unit Tests
        working-directory: frontend
        run: |
          echo "Running Feature Unit Tests..."
          # User Tests
          if [ -d "test/features/user/" ]; then
            flutter test test/features/user/ --coverage
          fi
          # Health Assessment Tests
          if [ -d "test/features/health_assessment/" ]; then
            flutter test test/features/health_assessment/ --coverage
          fi
          # Forecasting Tests
          if [ -d "test/features/forecasting/" ]; then
            flutter test test/features/forecasting/ --coverage
          fi
          # Recommendation Tests
          if [ -d "test/features/recommendation/" ]; then
            flutter test test/features/recommendation/ --coverage
          fi

      - name: Generate unit test coverage report
        working-directory: frontend
        run: |
          # Combine all unit test coverage
          flutter test --coverage \
            test/core/ \
            test/features/auth/domain/ \
            test/features/auth/data/ \
            test/features/auth/presentation/bloc/ \
            test/features/user/ \
            test/features/health_assessment/ \
            test/features/forecasting/ \
            test/features/recommendation/ \
            --exclude-tags=widget || true

          flutter pub global run coverage:format_coverage \
            --lcov \
            --in=coverage \
            --out=coverage/unit_lcov.info \
            --report-on=lib

      - name: Upload unit test coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: frontend/coverage/unit_lcov.info
          flags: frontend-unit-tests
          name: frontend-unit-coverage

  # Frontend widget tests (matching widget_test_runner.ps1)
  frontend_widget_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            frontend/.dart_tool
            frontend/build
          key: ${{ runner.os }}-flutter-widget-${{ hashFiles('frontend/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-widget-

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"

      - name: Install dependencies
        working-directory: frontend
        run: |
          flutter pub get
          flutter pub global activate coverage

      - name: Regenerate mocks
        working-directory: frontend
        run: |
          flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Run Authentication Widget Tests
        working-directory: frontend
        run: |
          echo "Running Authentication Widget Tests..."
          # Individual widget test files
          if [ -f "test/features/auth/presentation/widgets/login_screen_test.dart" ]; then
            flutter test test/features/auth/presentation/widgets/login_screen_test.dart --coverage
          fi
          if [ -f "test/features/auth/presentation/widgets/signup_screen_test.dart" ]; then
            flutter test test/features/auth/presentation/widgets/signup_screen_test.dart --coverage
          fi
          if [ -f "test/features/auth/presentation/widgets/custom_input_field_test.dart" ]; then
            flutter test test/features/auth/presentation/widgets/custom_input_field_test.dart --coverage
          fi
          if [ -f "test/features/auth/presentation/widgets/loading_button_test.dart" ]; then
            flutter test test/features/auth/presentation/widgets/loading_button_test.dart --coverage
          fi
          # Or run all auth widget tests
          if [ -d "test/features/auth/presentation/widgets/" ]; then
            flutter test test/features/auth/presentation/widgets/ --coverage
          fi

      - name: Run Screen Widget Tests
        working-directory: frontend
        run: |
          echo "Running Screen Widget Tests..."
          # Home Screen Tests
          if [ -d "test/presentation/ui/home/" ]; then
            flutter test test/presentation/ui/home/ --coverage
          fi
          # Profile Widget Tests
          if [ -d "test/presentation/ui/profile/" ]; then
            flutter test test/presentation/ui/profile/ --coverage
          fi
          # Health Assessment Widget Tests
          if [ -d "test/presentation/ui/health_assessment/" ]; then
            flutter test test/presentation/ui/health_assessment/ --coverage
          fi
          # Forecasting Widget Tests
          if [ -d "test/presentation/ui/forecasting/" ]; then
            flutter test test/presentation/ui/forecasting/ --coverage
          fi
          # Recommendation Widget Tests
          if [ -d "test/presentation/ui/recommendation/" ]; then
            flutter test test/presentation/ui/recommendation/ --coverage
          fi
          # Chatbot Widget Tests
          if [ -d "test/presentation/ui/chatbot/" ]; then
            flutter test test/presentation/ui/chatbot/ --coverage
          fi

      - name: Generate widget test coverage report
        working-directory: frontend
        run: |
          # Combine all widget test coverage
          flutter test --coverage \
            test/features/auth/presentation/widgets/ \
            test/presentation/ui/ || true

          flutter pub global run coverage:format_coverage \
            --lcov \
            --in=coverage \
            --out=coverage/widget_lcov.info \
            --report-on=lib

      - name: Upload widget test coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: frontend/coverage/widget_lcov.info
          flags: frontend-widget-tests
          name: frontend-widget-coverage

  # Frontend integration tests
  frontend_integration_tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false
    steps:
      - uses: actions/checkout@v3

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            frontend/.dart_tool
            frontend/build
          key: ${{ runner.os }}-flutter-integration-${{ hashFiles('frontend/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-integration-

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"

      - name: Install dependencies
        working-directory: frontend
        run: flutter pub get

      # Enable desktop support for Linux
      - name: Enable Linux desktop
        if: matrix.os == 'ubuntu-latest'
        working-directory: frontend
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev
          flutter config --enable-linux-desktop

      # Run integration tests
      - name: Run integration tests (Linux)
        if: matrix.os == 'ubuntu-latest'
        working-directory: frontend
        run: |
          export DISPLAY=:99
          sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
          flutter test integration_test/app_test.dart -d linux

      - name: Run integration tests (Windows)
        if: matrix.os == 'windows-latest'
        working-directory: frontend
        run: flutter test integration_test/app_test.dart -d windows

      - name: Run integration tests (macOS)
        if: matrix.os == 'macos-latest'
        working-directory: frontend
        run: flutter test integration_test/app_test.dart -d macos

  # Build job
  build:
    needs: [frontend_unit_tests, frontend_widget_tests, backend_tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            frontend/.dart_tool
            frontend/build
          key: ${{ runner.os }}-flutter-build-${{ hashFiles('frontend/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-build-

      - name: Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            frontend/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('frontend/android/**/*.gradle*', 'frontend/android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "11"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.1"
          channel: "stable"

      - name: Get dependencies
        working-directory: frontend
        run: flutter pub get

      - name: Build APK
        working-directory: frontend
        run: flutter build apk --split-per-abi --release

      - name: Build App Bundle
        working-directory: frontend
        run: flutter build appbundle --release

      # Upload artifacts for pull requests
      - name: Upload APK artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v3
        with:
          name: apk-artifacts
          path: frontend/build/app/outputs/flutter-apk/app-*-release.apk

      - name: Upload App Bundle
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v3
        with:
          name: appbundle-artifact
          path: frontend/build/app/outputs/bundle/release/app-release.aab

      # Create release only on main branch push
      - name: Push to Releases
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          artifacts: "frontend/build/app/outputs/flutter-apk/app-*-release.apk,frontend/build/app/outputs/bundle/release/app-release.aab"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: |
            ## ðŸš€ Ethio-AgriBizBoost Release

            ### ðŸ“± APK Files
            - `app-armeabi-v7a-release.apk` - For older Android devices
            - `app-arm64-v8a-release.apk` - For modern 64-bit Android devices
            - `app-x86_64-release.apk` - For Android emulators

            ### ðŸ“¦ App Bundle
            - `app-release.aab` - For Google Play Store submission

            ### âœ… Tests Passed
            - Frontend unit tests (entities, DTOs, services, BLoCs)
            - Frontend widget tests (UI components, screens)
            - Frontend integration tests
            - Backend tests (if applicable)

            ### ðŸ“Š Test Categories
            - **Critical Foundation Tests**: Token storage, auth entities
            - **Infrastructure Tests**: Network client, API configuration
            - **Unit Tests**: Business logic, data models, services
            - **Widget Tests**: UI components, screen rendering
            - **Integration Tests**: End-to-end flows
          draft: false
          prerelease: false
